<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protein Mutation Visualizer</title>
    <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #viewer_container {
            width: 100%;
            height: 600px;
            position: relative;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f0f0f0;
        }
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-4 text-blue-700">Gene Mutation Visualizer</h1>
        <p class="mb-4 text-gray-600">AlphaFold DB êµ¬ì¡°ë¥¼ ë¶ˆëŸ¬ì™€ ë³€ì´ ìœ„ì¹˜ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700">Gene Symbol</label>
                <input type="text" id="geneInput" value="TP53" placeholder="ì˜ˆ: TP53" 
                       class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">HGVSp Short</label>
                <input type="text" id="mutationInput" value="p.E294*" placeholder="ì˜ˆ: p.Arg175His ë˜ëŠ” p.E294*" 
                       class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex items-end">
                <button onclick="visualize()" 
                        class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition">
                    êµ¬ì¡° í™•ì¸í•˜ê¸°
                </button>
            </div>
        </div>

        <div id="statusMsg" class="mb-2 text-sm font-semibold h-6"></div>

        <div id="viewer_container">
            <div id="gldiv" style="width: 100%; height: 100%;"></div>
            <div id="loading" class="loading-overlay">
                <span class="text-xl font-bold animate-pulse">ë°ì´í„° ë¡œë”© ì¤‘...</span>
            </div>
        </div>
        
        <div class="mt-4 text-xs text-gray-500">
            * Data Source: AlphaFold Protein Structure Database & MyGene.info<br>
            * Viewer: 3Dmol.js
        </div>
    </div>

    <script>
        let viewer = null;

        $(document).ready(function() {
            // ë·°ì–´ ì´ˆê¸°í™”
            let element = document.getElementById('gldiv');
            viewer = $3Dmol.createViewer(element, {backgroundColor: 'white'});
        });

        async function visualize() {
            const gene = $('#geneInput').val().trim().toUpperCase();
            const hgvsp = $('#mutationInput').val().trim();
            const status = $('#statusMsg');
            const loader = $('#loading');

            // ìƒíƒœ ë©”ì‹œì§€ ì´ˆê¸°í™”
            status.text("").css('color', 'black');

            if (!gene || !hgvsp) {
                status.text("âš ï¸ Gene Symbolê³¼ Mutation ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.").css('color', 'red');
                return;
            }

            // --- [í•µì‹¬ ìˆ˜ì •] ìˆ«ìë§Œ ì¶”ì¶œí•˜ëŠ” ë¡œì§ ---
            // 'Prot' ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´ ì •ê·œì‹(Regex)ì„ ì‚¬ìš©í•˜ì—¬ ìˆ«ìë§Œ ì¶”ì¶œ
            // ì˜ˆ: "p.Arg175His" -> "175", "p.E294*" -> "294", "E294" -> "294"
            const residueMatch = hgvsp.match(/(\d+)/); 

            if (!residueMatch) {
                status.text("âš ï¸ ì…ë ¥ ê°’ì—ì„œ ë³€ì´ ìœ„ì¹˜(ìˆ«ì)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.").css('color', 'red');
                return;
            }
            const residuePos = parseInt(residueMatch[1]); // ì¶”ì¶œëœ ìˆ«ì
            // ------------------------------------

            loader.css('display', 'flex');
            status.text(`ğŸ” ${gene} ê²€ìƒ‰ ì¤‘...`);

            try {
                // 1. Gene Symbol -> UniProt ID ë³€í™˜ (MyGene.info)
                const geneData = await $.ajax({
                    url: `https://mygene.info/v3/query?q=symbol:${gene}&fields=uniprot`,
                    method: 'GET'
                });

                if (!geneData.hits || geneData.hits.length === 0 || !geneData.hits[0].uniprot) {
                    throw new Error("UniProt IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Gene Symbolì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                }

                // UniProt ID ì¶”ì¶œ (Swiss-Prot ìš°ì„ )
                let uniprotID = null;
                const uniprotObj = geneData.hits[0].uniprot;

                if (uniprotObj['Swiss-Prot']) {
                    uniprotID = Array.isArray(uniprotObj['Swiss-Prot']) ? uniprotObj['Swiss-Prot'][0] : uniprotObj['Swiss-Prot'];
                } else if (uniprotObj.TrEMBL) {
                    uniprotID = Array.isArray(uniprotObj.TrEMBL) ? uniprotObj.TrEMBL[0] : uniprotObj.TrEMBL;
                }

                if (!uniprotID) throw new Error("ìœ íš¨í•œ UniProt IDê°€ ì—†ìŠµë‹ˆë‹¤.");
                
                status.text(`ğŸ§¬ UniProt ID: ${uniprotID} êµ¬ì¡° ë¡œë”© ì¤‘...`);

                // 2. AlphaFold DBì—ì„œ PDB íŒŒì¼ ë¡œë“œ
                const pdbUrl = `https://alphafold.ebi.ac.uk/files/AF-${uniprotID}-F1-model_v4.pdb`;

                // ê¸°ì¡´ ëª¨ë¸ ì§€ìš°ê¸°
                viewer.clear();
                
                // AJAXë¡œ PDB ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì—ëŸ¬ í•¸ë“¤ë§ì„ ìœ„í•´)
                await $.ajax({
                    url: pdbUrl,
                    success: function(data) {
                        viewer.addModel(data, "pdb");
                        
                        // ê¸°ë³¸ ìŠ¤íƒ€ì¼ (Cartoon)
                        viewer.setStyle({}, {cartoon: {color: 'spectrum'}});

                        // 3. Mutation ìœ„ì¹˜ í•˜ì´ë¼ì´íŠ¸
                        // ë¹¨ê°„ìƒ‰ ë§‰ëŒ€(Stick)ì™€ êµ¬(Sphere)ë¡œ í‘œì‹œ
                        viewer.addStyle({resi: residuePos}, {stick: {colorscheme: 'redCarbon', radius: 0.3}});
                        viewer.addStyle({resi: residuePos}, {sphere: {color: 'red', opacity: 0.6, scale: 0.8}});
                        
                        // ë¼ë²¨ ì¶”ê°€
                        viewer.addLabel(`Mutation: ${hgvsp}`, {
                            position: {resi: residuePos}, 
                            backgroundColor: 'black', 
                            fontColor: 'white',
                            fontSize: 16,
                            showBackground: true,
                            alignment: 'center'
                        });

                        // ì¤Œì¸
                        viewer.zoomTo();
                        // ë³€ì´ ìœ„ì¹˜ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì¹´ë©”ë¼ ì¡°ì • (ì„ íƒ ì‚¬í•­)
                        // viewer.zoomTo({resi: residuePos}); 

                        viewer.render();
                        status.text(`âœ… ${gene} êµ¬ì¡° ë¡œë“œ ì™„ë£Œ. (Pos: ${residuePos})`).css('color', 'green');
                    },
                    error: function(xhr) {
                        if(xhr.status === 404) {
                            throw new Error(`AlphaFold DBì— ${uniprotID} êµ¬ì¡°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                        } else {
                            throw new Error("êµ¬ì¡° íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        }
                    }
                });

            } catch (error) {
                console.error(error);
                status.text(`âŒ ${error.message}`).css('color', 'red');
            } finally {
                loader.css('display', 'none');
            }
        }
    </script>
</body>
</html>
