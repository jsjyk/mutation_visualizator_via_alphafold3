<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Colab Protein Visualizer</title>
    <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #viewer_container { width: 100%; height: 500px; position: relative; background-color: #f8f9fa; border: 1px solid #ddd; }
        .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 50; }
    </style>
</head>
<body class="bg-gray-100 p-6">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold text-blue-700 mb-2">Colab ì—°ë™ ìë™ ì˜ˆì¸¡ê¸°</h1>
        <p class="text-sm text-gray-600 mb-6">Colabì—ì„œ ìƒì„±ëœ URLì„ ì—°ê²°í•˜ë©´, ì›¹ì—ì„œ ë²„íŠ¼ í´ë¦­ë§Œìœ¼ë¡œ êµ¬ì¡°ë¥¼ ì˜ˆì¸¡í•˜ê³  ì‹œê°í™”í•©ë‹ˆë‹¤.</p>

        <div class="bg-gray-800 text-white p-4 rounded mb-6">
            <label class="block text-xs font-bold text-green-400 mb-1">STEP 1. Colab ì„œë²„ ì£¼ì†Œ ì—°ê²°</label>
            <div class="flex gap-2">
                <input type="text" id="serverUrl" placeholder="ì˜ˆ: https://a1b2-34-56.ngrok-free.app" 
                       class="flex-1 bg-gray-700 border border-gray-600 rounded p-2 text-sm text-white focus:outline-none focus:border-green-500">
                <button onclick="checkConnection()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm font-bold">ì—°ê²° í™•ì¸</button>
            </div>
            <p id="connectionStatus" class="text-xs mt-2 text-gray-400">ğŸ”´ ì—°ê²°ë˜ì§€ ì•ŠìŒ</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-sm font-bold text-gray-700">Gene Symbol</label>
                <input type="text" id="geneInput" value="TP53" class="w-full border p-2 rounded mt-1">
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700">Mutation</label>
                <input type="text" id="mutInput" value="p.R175H" class="w-full border p-2 rounded mt-1">
            </div>
        </div>

        <button onclick="runAutoPrediction()" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 transition shadow-lg mb-4">
            ğŸš€ Colabìœ¼ë¡œ ì˜ˆì¸¡ ìš”ì²­ ë° ì‹œê°í™” (Auto Run)
        </button>

        <div id="viewer_container" class="rounded-lg overflow-hidden shadow-inner">
            <div id="gldiv" class="w-full h-full"></div>
            <div id="loading" class="loading-overlay">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-2"></div>
                <span id="loadText" class="text-blue-800 font-bold">ëŒ€ê¸° ì¤‘...</span>
            </div>
        </div>
        
        <div id="logArea" class="mt-4 p-2 bg-black text-green-400 text-xs font-mono h-24 overflow-y-auto rounded">Ready.</div>
    </div>

    <script>
        let viewer = null;
        let serverUrl = "";

        document.addEventListener("DOMContentLoaded", () => {
            viewer = $3Dmol.createViewer(document.getElementById('gldiv'), {backgroundColor: 'white'});
        });

        function log(msg) {
            const area = document.getElementById('logArea');
            area.innerHTML += `<div>> ${msg}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        async function checkConnection() {
            const urlInput = document.getElementById('serverUrl').value.trim();
            if (!urlInput) return alert("URLì„ ì…ë ¥í•˜ì„¸ìš”.");
            
            // ëì— ìŠ¬ë˜ì‹œ ì œê±°
            serverUrl = urlInput.replace(/\/$/, ""); 

            try {
                const res = await fetch(serverUrl + '/');
                if (res.ok) {
                    document.getElementById('connectionStatus').innerHTML = `ğŸŸ¢ ì—°ê²°ë¨: ${serverUrl}`;
                    log("Server Connected successfully.");
                }
            } catch (e) {
                document.getElementById('connectionStatus').innerHTML = `ğŸ”´ ì—°ê²° ì‹¤íŒ¨. Colabì´ ì¼œì ¸ìˆë‚˜ìš”?`;
                log("Connection Failed: " + e.message);
            }
        }

        async function runAutoPrediction() {
            if (!serverUrl) return alert("ë¨¼ì € Colab ì„œë²„ì™€ ì—°ê²°í•´ì£¼ì„¸ìš”.");

            const gene = document.getElementById('geneInput').value.toUpperCase();
            const mut = document.getElementById('mutInput').value;
            const loader = document.getElementById('loading');
            const loadText = document.getElementById('loadText');

            loader.style.display = 'flex';
            loadText.innerText = "1/3. ìœ ì „ì ì„œì—´ ë°ì´í„° í™•ë³´ ì¤‘...";

            try {
                // 1. MyGene.infoì—ì„œ ì„œì—´(Sequence)ì€ ëª»ê°€ì ¸ì˜¤ë¯€ë¡œ UniProtì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨ (ê°„ì†Œí™”)
                // ì‹¤ì œë¡œëŠ” ì—¬ê¸°ì„œ Gene -> UniProt ID -> Sequence ë³€í™˜ í›„ Mutation ì ìš© ë¡œì§ì´ í•„ìš”í•¨
                // ì‹œì—°ì„ ìœ„í•´ 'ê°€ìƒì˜ ë³€ì´ëœ ì„œì—´'ì„ ë§Œë“ ë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜, Colab ìª½ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ ìœ„ì„ ê°€ëŠ¥
                
                // ê°„ë‹¨íˆ: UniProt ID ì°¾ê¸°
                const geneRes = await fetch(`https://mygene.info/v3/query?q=symbol:${gene}&fields=uniprot`);
                const geneData = await geneRes.json();
                const uniprotId = geneData.hits[0].uniprot['Swiss-Prot'] || geneData.hits[0].uniprot.TrEMBL; // ë°°ì—´ ì²˜ë¦¬ í•„ìš”í•˜ë‚˜ ìƒëµ
                
                log(`Target: ${gene} (${uniprotId})`);
                loadText.innerText = "2/3. Colab GPU ì—°ì‚° ì¤‘... (ì‹œê°„ì´ ì†Œìš”ë©ë‹ˆë‹¤)";

                // 2. Colab ì„œë²„ë¡œ ìš”ì²­ ì „ì†¡
                // (ì‹¤ì œë¡œëŠ” ì—¬ê¸°ì„œ ì›ë³¸ ì„œì—´ì„ ê°€ì ¸ì™€ ë³€ì´ë¥¼ ì ìš©í•œ 'mutated_sequence'ë¥¼ ë³´ë‚´ì•¼ í•¨)
                // ë°ëª¨ìš©: ì§§ì€ í…ŒìŠ¤íŠ¸ ì„œì—´ ì „ì†¡
                const mockSequence = "MKTVRQERLKSIVRILERSKEPVSGAQLAEELSVSRQVIVQDIAYLRSLGYNIVATPRGYVLAGG"; 

                const response = await fetch(serverUrl + '/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        gene: gene,
                        mutation: mut,
                        sequence: mockSequence // ì‹¤ì œë¡œëŠ” ë³€ì´ëœ ì „ì²´ ê¸´ ì„œì—´
                    })
                });

                if (!response.ok) throw new Error("Server Error");
                const result = await response.json();

                if (result.status === 'success') {
                    log("Prediction received from Colab!");
                    
                    // 3. ì‹œê°í™”
                    viewer.clear();
                    viewer.addModel(result.pdb, "pdb");
                    viewer.setStyle({}, {cartoon: {color: 'spectrum'}});
                    viewer.zoomTo();
                    viewer.render();
                    
                    loadText.innerText = "ì™„ë£Œ!";
                } else {
                    throw new Error(result.message);
                }

            } catch (e) {
                log("Error: " + e.message);
                alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            } finally {
                loader.style.display = 'none';
            }
        }
    </script>
</body>
</html>
