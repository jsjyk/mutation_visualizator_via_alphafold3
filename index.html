<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protein Mutation Visualizer (AlphaFold DB)</title>
    <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #viewer_container {
            width: 100%;
            height: 600px;
            position: relative;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f0f0f0;
        }
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-4 text-blue-700">Gene Mutation Visualizer</h1>
        <p class="mb-4 text-gray-600">AlphaFold DB êµ¬ì¡°ë¥¼ ë¶ˆëŸ¬ì™€ ë³€ì´ ìœ„ì¹˜ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700">Gene Symbol</label>
                <input type="text" id="geneInput" value="TP53" placeholder="ì˜ˆ: TP53" 
                       class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">HGVSp Short</label>
                <input type="text" id="mutationInput" value="p.Arg175His" placeholder="ì˜ˆ: p.Arg175His" 
                       class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex items-end">
                <button onclick="visualize()" 
                        class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition">
                    êµ¬ì¡° í™•ì¸í•˜ê¸°
                </button>
            </div>
        </div>

        <div id="statusMsg" class="mb-2 text-sm font-semibold text-gray-700"></div>

        <div id="viewer_container">
            <div id="gldiv" style="width: 100%; height: 100%;"></div>
            <div id="loading" class="loading-overlay">
                <span class="text-xl font-bold animate-pulse">ë°ì´í„° ë¡œë”© ì¤‘...</span>
            </div>
        </div>
        
        <div class="mt-4 text-xs text-gray-500">
            * Data Source: AlphaFold Protein Structure Database & MyGene.info<br>
            * Viewer: 3Dmol.js
        </div>
    </div>

    <script>
        let viewer = null;

        $(document).ready(function() {
            // ë·°ì–´ ì´ˆê¸°í™”
            let element = document.getElementById('gldiv');
            viewer = $3Dmol.createViewer(element, {backgroundColor: 'white'});
        });

        async function visualize() {
            const gene = $('#geneInput').val().trim().toUpperCase();
            const hgvsp = $('#mutationInput').val().trim();
            const status = $('#statusMsg');
            const loader = $('#loading');

            if (!gene || !hgvsp) {
                status.text("âš ï¸ Gene Symbolê³¼ Mutation ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.").css('color', 'red');
                return;
            }

            // Mutation ìœ„ì¹˜ íŒŒì‹± (ì˜ˆ: p.Arg175His -> 175)
            const residueMatch = hgvsp.match(/(\d+)/);
            if (!residueMatch) {
                status.text("âš ï¸ HGVSp í˜•ì‹ì—ì„œ ìœ„ì¹˜(ìˆ«ì)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.").css('color', 'red');
                return;
            }
            const residuePos = parseInt(residueMatch[1]);

            loader.css('display', 'flex');
            status.text(`ğŸ” ${gene}ì˜ UniProt ID ê²€ìƒ‰ ì¤‘...`).css('color', 'black');

            try {
                // 1. Gene Symbol -> UniProt ID ë³€í™˜ (MyGene.info API)
                const geneData = await $.ajax({
                    url: `https://mygene.info/v3/query?q=symbol:${gene}&fields=uniprot`,
                    method: 'GET'
                });

                if (!geneData.hits || geneData.hits.length === 0 || !geneData.hits[0].uniprot || !geneData.hits[0].uniprot.Swiss-Prot) {
                    throw new Error("UniProt IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Gene Symbolì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                }

                // Swiss-Prot IDê°€ ìš°ì„ , ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ID ì‚¬ìš©
                const uniprotID = geneData.hits[0].uniprot['Swiss-Prot'] || geneData.hits[0].uniprot.TrEMBL[0];
                
                status.text(`ğŸ§¬ UniProt ID: ${uniprotID} / AlphaFold êµ¬ì¡° ë‹¤ìš´ë¡œë“œ ì¤‘...`);

                // 2. AlphaFold DBì—ì„œ PDB íŒŒì¼ ë¡œë“œ
                // AlphaFold DB URL íŒ¨í„´: https://alphafold.ebi.ac.uk/files/AF-[UNIPROT]-F1-model_v4.pdb
                const pdbUrl = `https://alphafold.ebi.ac.uk/files/AF-${uniprotID}-F1-model_v4.pdb`;

                // 3Dmol.jsë¡œ ë¡œë“œ
                viewer.clear();
                
                // AJAXë¡œ PDB í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ê°€ì ¸ì™€ì„œ ì—ëŸ¬ í•¸ë“¤ë§
                try {
                    await $.ajax({
                        url: pdbUrl,
                        success: function(data) {
                            viewer.addModel(data, "pdb");
                            
                            // ìŠ¤íƒ€ì¼ ì„¤ì •
                            viewer.setStyle({}, {cartoon: {color: 'spectrum'}}); // ì „ì²´ êµ¬ì¡°: Cartoon ìŠ¤íƒ€ì¼

                            // 3. Mutation ìœ„ì¹˜ í•˜ì´ë¼ì´íŠ¸
                            // PDB íŒŒì¼ì€ residue ë²ˆí˜¸ê°€ 1ë¶€í„° ì‹œì‘í•˜ëŠ” ê²½ìš°ê°€ ë§ìŒ.
                            // hgvsp ìˆ«ìì™€ ë§¤ì¹­
                            
                            // ì„ íƒì ì„¤ì •: resiëŠ” residue number
                            viewer.addStyle({resi: residuePos}, {stick: {colorscheme: 'redCarbon', radius: 0.3}});
                            viewer.addStyle({resi: residuePos}, {sphere: {color: 'red', opacity: 0.7, scale: 0.5}});
                            
                            // ë¼ë²¨ ì¶”ê°€
                            viewer.addLabel(`Mutation: ${hgvsp}`, {
                                position: {resi: residuePos}, 
                                backgroundColor: 'black', 
                                fontColor: 'white',
                                fontSize: 16
                            });

                            viewer.zoomTo();
                            viewer.render();
                            
                            status.text(`âœ… ${gene} (${uniprotID}) êµ¬ì¡° ë¡œë“œ ì™„ë£Œ. ë³€ì´ ìœ„ì¹˜: ${residuePos}`).css('color', 'green');
                        },
                        error: function() {
                            throw new Error("AlphaFold DBì— í•´ë‹¹ ë‹¨ë°±ì§ˆì˜ êµ¬ì¡°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        }
                    });
                } catch (e) {
                    throw e;
                }

            } catch (error) {
                console.error(error);
                status.text(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message || error.responseText}`).css('color', 'red');
            } finally {
                loader.css('display', 'none');
            }
        }
    </script>
</body>
</html>
