<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protein Mutation Visualizer</title>
    <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #viewer_container {
            width: 100%;
            height: 600px;
            position: relative;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f0f0f0;
        }
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-4 text-blue-700">Gene Mutation Visualizer (v3)</h1>
        <p class="mb-4 text-gray-600">AlphaFold DB 구조를 로드하여 변이 위치를 시각화합니다.</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700">Gene Symbol</label>
                <input type="text" id="geneInput" value="TP53" placeholder="예: TP53" 
                       class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">HGVSp / Position</label>
                <input type="text" id="mutationInput" value="p.Arg175His" placeholder="예: p.Arg175His, p.E294*, 294" 
                       class="mt-1 block w-full border border-gray-300 rounded-md p-2 shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex items-end">
                <button onclick="visualize()" 
                        class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition font-bold">
                    구조 확인하기
                </button>
            </div>
        </div>

        <div id="statusMsg" class="mb-2 text-sm font-bold min-h-[24px]"></div>

        <div id="viewer_container">
            <div id="gldiv" style="width: 100%; height: 100%;"></div>
            <div id="loading" class="loading-overlay">
                <span class="text-xl font-bold text-blue-600 animate-pulse mb-2">데이터 처리 중...</span>
                <span id="loadingText" class="text-sm text-gray-500">잠시만 기다려주세요</span>
            </div>
        </div>
        
        <div class="mt-4 text-xs text-gray-500">
            * Data Source: AlphaFold Protein Structure Database, MyGene.info<br>
            * Viewer: 3Dmol.js
        </div>
    </div>

    <script>
        let viewer = null;

        $(document).ready(function() {
            // 뷰어 초기화
            let element = document.getElementById('gldiv');
            viewer = $3Dmol.createViewer(element, {backgroundColor: 'white'});
        });

        async function visualize() {
            const gene = $('#geneInput').val().trim().toUpperCase();
            const inputMutation = $('#mutationInput').val().trim();
            const status = $('#statusMsg');
            const loader = $('#loading');
            const loadText = $('#loadingText');

            // UI 초기화
            status.text("").css('color', 'black');
            loader.css('display', 'flex');

            try {
                // 1. 입력값 검증
                if (!gene || !inputMutation) {
                    throw new Error("Gene Symbol과 Mutation 정보를 모두 입력해주세요.");
                }

                // 2. 숫자 추출 (어떤 형식이든 숫자만 뽑아냄)
                const residueMatch = inputMutation.match(/(\d+)/);
                if (!residueMatch) {
                    throw new Error("입력 값에서 변이 위치(숫자)를 찾을 수 없습니다.");
                }
                const residuePos = parseInt(residueMatch[1]);

                // 3. MyGene.info에서 UniProt ID 검색
                loadText.text(`Gene '${gene}' 정보 검색 중...`);
                
                // jQuery AJAX를 Promise로 감싸서 에러 핸들링 강화
                const geneData = await new Promise((resolve, reject) => {
                    $.ajax({
                        url: `https://mygene.info/v3/query?q=symbol:${gene}&fields=uniprot`,
                        method: 'GET',
                        success: resolve,
                        error: (jqXHR, textStatus, errorThrown) => {
                            reject(new Error(`Gene 검색 실패: ${textStatus} - ${errorThrown}`));
                        }
                    });
                });

                console.log("Gene Data:", geneData); // 디버깅용 로그

                if (!geneData.hits || geneData.hits.length === 0) {
                    throw new Error(`'${gene}'에 대한 검색 결과가 없습니다.`);
                }

                const hit = geneData.hits[0];
                if (!hit.uniprot) {
                    throw new Error(`'${gene}'의 UniProt ID 정보가 없습니다.`);
                }

                // UniProt ID 추출 로직 (Swiss-Prot 우선, 없으면 TrEMBL)
                let uniprotID = null;
                if (hit.uniprot['Swiss-Prot']) {
                    uniprotID = hit.uniprot['Swiss-Prot'];
                } else if (hit.uniprot.TrEMBL) {
                    uniprotID = hit.uniprot.TrEMBL;
                }

                // 배열인 경우 첫 번째 값 사용
                if (Array.isArray(uniprotID)) {
                    uniprotID = uniprotID[0];
                }

                if (!uniprotID) {
                    throw new Error("유효한 UniProt ID를 추출하지 못했습니다.");
                }

                loadText.text(`UniProt ID: ${uniprotID} 구조 다운로드 중...`);

                // 4. AlphaFold PDB 데이터 로드
                const pdbUrl = `https://alphafold.ebi.ac.uk/files/AF-${uniprotID}-F1-model_v4.pdb`;

                viewer.clear();

                await new Promise((resolve, reject) => {
                    $.ajax({
                        url: pdbUrl,
                        success: function(data) {
                            try {
                                viewer.addModel(data, "pdb");
                                viewer.setStyle({}, {cartoon: {color: 'spectrum'}});

                                // 변이 위치 표시
                                viewer.addStyle({resi: residuePos}, {stick: {colorscheme: 'redCarbon', radius: 0.3}});
                                viewer.addStyle({resi: residuePos}, {sphere: {color: 'red', opacity: 0.6, scale: 0.8}});
                                
                                viewer.addLabel(`Pos: ${residuePos} (${inputMutation})`, {
                                    position: {resi: residuePos}, 
                                    backgroundColor: 'black', 
                                    fontColor: 'white',
                                    fontSize: 16,
                                    showBackground: true
                                });

                                viewer.zoomTo();
                                viewer.render();
                                resolve();
                            } catch (e) {
                                reject(e);
                            }
                        },
                        error: function(jqXHR) {
                            if (jqXHR.status === 404) {
                                reject(new Error(`AlphaFold DB에 ${uniprotID} 구조 파일이 없습니다.`));
                            } else {
                                reject(new Error(`구조 파일 다운로드 실패 (상태 코드: ${jqXHR.status})`));
                            }
                        }
                    });
                });

                status.text(`✅ ${gene} (${uniprotID}) 로드 완료. 변이 위치: ${residuePos}`).css('color', 'green');

            } catch (error) {
                console.error("Error Detail:", error);
                
                // 에러 메시지 추출 (undefined 방지)
                let msg = error.message;
                if (!msg) msg = JSON.stringify(error);
                if (msg === "{}") msg = "알 수 없는 네트워크 오류가 발생했습니다.";

                status.text(`❌ 오류 발생: ${msg}`).css('color', 'red');
            } finally {
                loader.css('display', 'none');
            }
        }
    </script>
</body>
</html>
